<!doctype html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>Minik Saƒülƒ±k Paneli</title>
<style>
:root{
--bg:#0b0f17; --card:#121a27; --text:#eaf0ff; --muted:#a9b4cc; --line:rgba(255,255,255,.08);
--accent:#4ade80; --warning:#fbbf24; --danger:#ff6b6b; --early:#60a5fa;
}
* { box-sizing: border-box; }
body{ margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui; padding:10px; -webkit-font-smoothing: antialiased; overflow-x: hidden; }

/* G√úVENLƒ∞K KALKANI */
.safety-shield { display: none; background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: white; padding: 10px; text-align: center; font-weight: 900; font-size: 13px; position: sticky; top: 0; z-index: 9999; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); animation: pulse-red 1.5s infinite; letter-spacing: 0.5px; }

/* ORTALANMI≈û KOMPAKT BA≈ûLIK */
.header-compact { text-align: center; margin-bottom: 10px; background: var(--card); padding: 8px; border-radius: 16px; border: 1px solid var(--line); }
.app-title { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 4px; }
.header-info { display: flex; justify-content: center; align-items: center; gap: 8px; }
.clock-text { font-size: 12px; font-weight: 700; color: var(--muted); }
.sync-badge { font-size: 11px; font-weight: 800; padding: 2px 8px; border-radius: 8px; background: rgba(0,0,0,0.3); }

/* PERFORMANS BARI */
.perf-compact { display: flex; align-items: center; gap: 10px; background: var(--card); border-radius: 14px; padding: 10px 12px; margin-bottom: 10px; border: 1px solid var(--line); }
.perf-label { font-size: 12px; font-weight: 800; white-space: nowrap; }
.bar-bg { flex: 1; background: rgba(255,255,255,0.05); height: 8px; border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; transition: width 1s ease-in-out, background-color 0.5s; }
.perf-val { font-size: 13px; font-weight: 800; font-family: ui-monospace, monospace; }

/* G√úNL√úK √áƒ∞ZELGE - B√úY√úK KAPS√úLLER */
.daily-container { background: var(--card); border-radius: 16px; padding: 14px; margin-bottom: 10px; border: 1px solid var(--line); }
.daily-title { font-size: 11px; font-weight: 800; color: var(--muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
.daily-row { display: flex; justify-content: space-between; gap: 6px; }
.daily-pill { flex: 1; text-align: center; padding: 12px 2px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; gap: 6px; border: 1px solid var(--line); background: rgba(255,255,255,0.02); min-height: 95px; }
.pill-name { font-size: 11px; color: #fff; font-weight: 900; }
.pill-time { color: var(--muted); font-size: 12px; font-weight: 800; font-family: ui-monospace, monospace; }
.pill-status-text { font-size: 8.5px; font-weight: 900; letter-spacing: -0.2px; padding: 4px 1px; border-radius: 6px; margin: 0 4px; display: flex; align-items: center; justify-content: center; min-height: 32px; text-align: center; line-height: 1.3; }

/* Kaps√ºl Renkleri */
.pill-stable { border-color: rgba(74,222,128,0.4); } .pill-stable .pill-status-text { background: rgba(74,222,128,0.15); color: #4ade80; }
.pill-early { border-color: rgba(96,165,250,0.4); } .pill-early .pill-status-text { background: rgba(96,165,250,0.15); color: #60a5fa; }
.pill-delayed { border-color: rgba(251,191,36,0.4); } .pill-delayed .pill-status-text { background: rgba(251,191,36,0.15); color: #fbbf24; }
.pill-missed { border-color: rgba(255,107,107,0.4); } .pill-missed .pill-status-text { background: rgba(255,107,107,0.15); color: #ff6b6b; }
.pill-waiting { border-color: var(--line); } .pill-waiting .pill-status-text { color: var(--muted); background: rgba(255,255,255,0.05); }

/* ƒ∞LA√á KARTLARI */
.cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.card { background: var(--card); border-radius: 16px; padding: 14px; border: 1px solid var(--line); display: flex; flex-direction: column; justify-content: space-between; }
.drug-name { font-size: 16px; font-weight: 800; display: flex; align-items: center; gap: 4px; margin-bottom: 6px; }
.badge { align-self: flex-start; padding: 4px 6px; border-radius: 6px; font-weight: 800; font-size: 9px; text-transform: uppercase; margin-bottom: 10px; }
.badge-safe { background:rgba(74,222,128,0.15); color:var(--accent); }
.badge-due { background:rgba(251,191,36,0.15); color:var(--warning); animation: pulse-yellow 2s infinite; }
.badge-late { background:rgba(255,107,107,0.15); color:var(--danger); animation: pulse-red 1s infinite; }
.info-group { margin-bottom: 8px; }
.label { color: var(--muted); font-size: 9px; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; }
.val-primary { font-size: 13px; font-weight: 800; color: #fff; }
.val-sub { font-size: 11px; color: var(--muted); font-weight: 600; }
.timer-box { margin-top: 2px; padding-top: 10px; border-top: 1px solid var(--line); }
.timer { font-weight: 800; color: var(--accent); font-size: 15px; font-family: ui-monospace, monospace; }
.timer.urgent { color: var(--warning); }
details { margin-top: 8px; border-top: 1px dashed var(--line); padding-top: 6px; }
summary { cursor: pointer; color: var(--muted); font-size: 11px; font-weight: 700; list-style: none; outline: none; display: flex; justify-content: space-between; align-items: center; }
.history-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px; color: #ccc; }
.mono { font-family: ui-monospace, monospace; }

/* EKSTRA KARTLAR (Puan & N√∂bet) */
.extra-card { background: var(--card); border-radius: 16px; padding: 12px 14px; border: 1px solid var(--line); margin-bottom: 10px; }
.extra-card summary { font-size: 14px; font-weight: 800; color: #fff; margin: 0; padding: 0; border: none; }
.extra-card summary .show-text { font-size: 10px; color: var(--muted); font-weight: 700; }
.score-row { display: flex; align-items: center; margin-bottom: 8px; }
.score-rank { width: 24px; font-weight: 900; font-size: 13px; }
.score-name { flex: 1; font-weight: 800; font-size: 13px; color: #fff; }
.score-val { font-weight: 900; font-size: 14px; font-family: ui-monospace, monospace; }

@keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
@keyframes pulse-yellow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
</style>
</head>
<body>

<div id="safety-shield" class="safety-shield"></div>

<div class="header-compact">
    <div class="app-title">üêæ Minik Paneli</div>
    <div class="header-info">
        <div id="clock" class="clock-text">--:--</div>
        <div id="last-sync" class="sync-badge">üîÑ Baƒülanƒ±yor...</div>
    </div>
</div>

<div class="perf-compact">
    <div class="perf-label">üìà 30 G√ºnl√ºk Ba≈üarƒ±</div>
    <div class="bar-bg"><div id="perf-bar" class="bar-fill" style="width: 0%"></div></div>
    <div id="perf-pct" class="perf-val">%0</div>
</div>

<div class="daily-container">
    <div class="daily-title">Bug√ºnk√º Dozlar</div>
    <div id="status-grid" class="daily-row"></div>
</div>

<div id="app" class="cards-grid"></div>

<div id="extra-cards"></div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbzbS3DIUOcmpUBLgvfuFhi3zIhsougq7JB93ccmnwLlGbURtHLZknu5vl6FcxSWJndIZA/exec"; 
let sonBasariZamani = 0;
let hamVeri = [];
let fetchDevamEdiyor = false;

async function veriCek() {
    if (fetchDevamEdiyor) return;
    fetchDevamEdiyor = true;
    try {
        const response = await fetch(SHEET_URL);
        if (!response.ok) throw new Error("Aƒü Hatasƒ±");
        hamVeri = await response.json();
        sonBasariZamani = Date.now();
        ekraniCiz(); 
    } catch(e) { console.error(e); } finally { fetchDevamEdiyor = false; }
}

function saniyeTiktak() {
    const syncElement = document.getElementById('last-sync');
    const clockElement = document.getElementById('clock');
    if (!syncElement) return;

    const simdi = Date.now();
    const farkSaniye = sonBasariZamani > 0 ? Math.floor((simdi - sonBasariZamani) / 1000) : 999;
    const dNow = new Date();
    
    if(clockElement) {
        clockElement.textContent = dNow.getDate() + " " + dNow.toLocaleDateString('tr-TR', {month:'short'}) + " ‚Ä¢ " + String(dNow.getHours()).padStart(2,'0') + ':' + String(dNow.getMinutes()).padStart(2,'0');
    }

    if (sonBasariZamani === 0) {
        syncElement.innerHTML = `üîÑ Sisteme Baƒülanƒ±yor...`; syncElement.style.color = "var(--warning)";
    } else if (farkSaniye < 20) {
        const d = new Date(sonBasariZamani);
        const sn = String(d.getSeconds()).padStart(2,'0');
        syncElement.innerHTML = `üü¢ Canlƒ± Veri (${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${sn})`;
        syncElement.style.color = "#4ade80";
    } else if (farkSaniye < 60) {
        syncElement.innerHTML = `üü° Gecikme Var: ${farkSaniye} sn`; syncElement.style.color = "#fbbf24";
    } else {
        syncElement.innerHTML = `üî¥ Hata! Baƒülantƒ± Yok`; syncElement.style.color = "#ef4444";
    }
}

function ekraniCiz() {
    if (hamVeri.length === 0) return;
    const detailsState = {}; document.querySelectorAll('details').forEach((d, i) => detailsState[i] = d.open);

    // ƒ∞LA√á LOGLARI (N√∂betleri Filtrele)
    const logs = hamVeri
        .filter(l => !l.i.toLowerCase().includes('n√∂bet'))
        .map(l => ({
            dt: new Date(l.dt),
            drug: l.i.toLowerCase().includes('kep') ? 'keppra' : 'enalapril',
            dRaw: l.i.toLowerCase().includes('kep') ? 'Keppra' : 'Enalapril',
            by: l.k.charAt(0).toUpperCase() + l.k.slice(1).toLowerCase() // ƒ∞simleri d√ºzelt (G√∂ker, Alper vb.)
        })).sort((a, b) => b.dt - a.dt);

    const now = new Date();
    const GRACE_MIN = 30;
    const fmt = d => String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    const isToday = (d) => d.toDateString() === now.toDateString();

    // 1. KALKAN
    const shield = document.getElementById('safety-shield');
    const son60dk = logs.filter(l => (now - l.dt) >= 0 && (now - l.dt) < (60 * 60000));
    if (son60dk.length > 0) {
        const r = son60dk[0]; const dkOnce = Math.floor((now - r.dt) / 60000);
        shield.innerHTML = `üö® Dƒ∞KKAT: ${r.dRaw}, ${r.by} tarafƒ±ndan ${dkOnce === 0 ? 'az √∂nce' : dkOnce+' dk √∂nce'} verildi!`;
        shield.style.display = 'block';
    } else { shield.style.display = 'none'; }

    // 2. KARTLAR
    const keppraTimes = [{h:7,m:0},{h:15,m:0},{h:23,m:0}];
    const enalaprilTimes = [{h:10,m:30},{h:22,m:30}];

    function getNextSmart(name) {
        const pArr = name.toLowerCase() === 'keppra' ? keppraTimes : enalaprilTimes;
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        let cands = [];
        [-1, 0, 1].forEach(off => { pArr.forEach(t => { cands.push(new Date(today.getTime() + (off * 86400000) + (t.h*3600 + t.m*60)*1000)); }); });
        cands.sort((a,b) => a-b);
        return cands.find(c => {
            const wasDone = logs.find(l => l.drug === name.toLowerCase() && Math.abs(l.dt - c) < (4 * 3600000));
            return !wasDone && c > now.getTime() - (GRACE_MIN*60000);
        }) || cands.find(c => c > now);
    }

    function renderDrug(name, icon) {
        const dLogs = logs.filter(l => l.drug === name.toLowerCase()); 
        const last = dLogs[0]; const next = getNextSmart(name);
        const diffMin = Math.round((next - now) / 60000);
        
        let status = { text: "BEKLEMEDE", class: "badge-safe" };
        if (last && (now - last.dt) >= 0 && (now - last.dt) < (GRACE_MIN * 60000)) status = { text: "YENƒ∞ VERƒ∞LDƒ∞", class: "badge-safe" };
        else if (diffMin <= 0 && diffMin >= -GRACE_MIN) status = { text: "VAKTƒ∞ GELDƒ∞", class: "badge-due" };
        else if (diffMin < -GRACE_MIN) status = { text: "GECƒ∞KTƒ∞", class: "badge-late" };

        const h = Math.floor(Math.abs(diffMin) / 60); const m = Math.abs(diffMin) % 60;
        const diffStr = diffMin < 0 ? "Ge√ßti!" : (h > 0 ? `${h}sa ${m}d` : `${m}dk`);
        const lastGivenStr = last ? `${isToday(last.dt) ? "Bug√ºn" : last.dt.getDate()+'/'+(last.dt.getMonth()+1)} ${fmt(last.dt)}` : '--';

        return `
            <div class="card">
                <div class="drug-name">${icon} ${name}</div>
                <div class="badge ${status.class}">${status.text}</div>
                
                <div class="info-group">
                    <div class="label">Son Verili≈ü</div>
                    <div class="val-primary">${lastGivenStr} <span class="val-sub">${last ? '('+last.by+')' : ''}</span></div>
                </div>

                <div class="timer-box">
                    <div class="label">Sƒ±radaki (${fmt(next)})</div>
                    <div class="timer ${diffMin < 60 ? 'urgent' : ''}">${diffStr}</div>
                </div>

                <details>
                    <summary><span>Ge√ßmi≈ü</span> <span class="show-text">G√∂ster ‚ñº</span></summary>
                    <ul style="list-style:none; padding:0; margin-top:5px">
                        ${dLogs.slice(0,4).map(h => `<li class="history-item"><span class="mono">${h.dt.getDate()}/${h.dt.getMonth()+1} ${fmt(h.dt)}</span><span style="font-weight:700">${h.by}</span></li>`).join('')}
                    </ul>
                </details>
            </div>`;
    }

    document.getElementById('app').innerHTML = renderDrug('Keppra', 'üíâ') + renderDrug('Enalapril', 'üíä');

    // 3. G√úNL√úK YATAY √áƒ∞ZELGE
    const allPlans = [{n:'Keppra',h:7,m:0},{n:'Enalapril',h:10,m:30},{n:'Keppra',h:15,m:0},{n:'Enalapril',h:22,m:30},{n:'Keppra',h:23,m:0}];
    let grid = ""; let totalP = 0; let stableC = 0;
    
    allPlans.forEach(p => {
        const pt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), p.h, p.m);
        const log = logs.find(l => l.drug === p.n.toLowerCase() && Math.abs(l.dt - pt) < (4 * 3600000));
        
        let tagText = "BEKLƒ∞YOR";
        let pClass = "pill-waiting";
        
        if (log) {
            const diffMin = (log.dt - pt) / 60000;
            if (diffMin < -30) { tagText = "ERKEN<br>VERƒ∞LDƒ∞"; pClass = "pill-early"; }
            else if (diffMin >= -30 && diffMin <= 30) { tagText = "ZAMANINDA<br>VERƒ∞LDƒ∞"; pClass = "pill-stable"; }
            else { tagText = "GE√á<br>VERƒ∞LDƒ∞"; pClass = "pill-delayed"; }
        } else if (now > new Date(pt.getTime() + 30*60000)) {
            tagText = "GECƒ∞KTƒ∞"; pClass = "pill-missed";
        }
        
        let shortName = p.n.substring(0,3).toUpperCase();
        grid += `<div class="daily-pill ${pClass}"><span class="pill-name">${shortName}</span><span class="pill-time">${fmt(pt)}</span><span class="pill-status-text">${tagText}</span></div>`;
    });
    
    // 4. BA≈ûARI (30 G√úNL√úK)
    let startCalc = new Date(now.getTime() - (30 * 86400000)); startCalc.setHours(0,0,0,0);
    for(let d=new Date(startCalc); d<=now; d.setDate(d.getDate()+1)){
        allPlans.forEach(p => {
            const pt = new Date(d.getFullYear(), d.getMonth(), d.getDate(), p.h, p.m);
            if(pt >= startCalc && pt <= now){
                totalP++; if(logs.find(l => l.drug === p.n.toLowerCase() && Math.abs(l.dt - pt.getTime()) <= (GRACE_MIN*60000))) stableC++;
            }
        });
    }

    const pct = totalP > 0 ? Math.round((stableC/totalP)*100) : 0;
    const clr = pct >= 80 ? "#4ade80" : (pct >= 50 ? "#fbbf24" : "#ff6b6b");
    
    document.getElementById('perf-pct').textContent = '%'+pct; document.getElementById('perf-pct').style.color = clr;
    document.getElementById('perf-bar').style.width = pct+'%'; document.getElementById('perf-bar').style.backgroundColor = clr;
    document.getElementById('status-grid').innerHTML = grid;

    // 5. AYLIK PUAN TABLOSU HESAPLAMA (Bu Ayƒ±n 1'inden Bug√ºne)
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const totalMonthDoses = daysInMonth * 5; // Ay boyunca verilmesi gereken toplam doz
    const ptsPerDose = 100 / totalMonthDoses; // Tam zamanƒ±nda verilirse alƒ±nacak puan
    
    let scores = {};
    for(let d=1; d<=now.getDate(); d++) {
        allPlans.forEach(p => {
            const pt = new Date(currentYear, currentMonth, d, p.h, p.m);
            if (pt > now) return; // Gelecek saatleri hesaplama
            
            const log = logs.find(l => l.drug === p.n.toLowerCase() && Math.abs(l.dt - pt) < (4 * 3600000));
            if (log) {
                const diffMin = (log.dt - pt) / 60000;
                let pts = ptsPerDose; // Tam Puan
                
                // Erken veya Ge√ß ise %25 Ceza
                if (diffMin < -30 || diffMin > 30) {
                    pts = ptsPerDose * 0.75; 
                }
                
                if(!scores[log.by]) scores[log.by] = 0;
                scores[log.by] += pts;
            }
        });
    }

    let sortedScores = Object.keys(scores).map(k => ({name: k, score: scores[k]})).sort((a,b) => b.score - a.score);
    const monthName = now.toLocaleDateString('tr-TR', {month:'long'});

    let leaderHTML = `
    <div class="extra-card">
        <details>
            <summary><span>üèÜ ${monthName} Puan Tablosu</span> <span class="show-text">G√∂ster ‚ñº</span></summary>
            <div style="margin-top:12px; border-top:1px dashed var(--line); padding-top:10px;">`;
    
    if (sortedScores.length === 0) {
        leaderHTML += `<div style="text-align:center; color:var(--muted); font-size:11px;">Bu ay hen√ºz veri yok.</div>`;
    } else {
        const medals = ["#fbbf24", "#9ca3af", "#b45309"]; // Altƒ±n, G√ºm√º≈ü, Bronz
        sortedScores.forEach((s, idx) => {
            let color = medals[idx] || "#4ade80";
            leaderHTML += `
                <div class="score-row">
                    <div class="score-rank" style="color:${color};">#${idx+1}</div>
                    <div class="score-name">${s.name}</div>
                    <div class="score-val" style="color:${color};">${s.score.toFixed(1)}</div>
                </div>
                <div class="bar-bg" style="height:6px; margin-bottom:12px;">
                    <div class="bar-fill" style="width:${s.score}%; background-color:${color};"></div>
                </div>`;
        });
    }
    leaderHTML += `</div></details></div>`;

    // 6. N√ñBET G√úNL√úƒû√ú
    const nobetLogs = hamVeri
        .filter(l => l.i.toLowerCase().includes('n√∂bet'))
        .map(l => ({ dt: new Date(l.dt), by: l.k }))
        .sort((a, b) => b.dt - a.dt);

    let nobetHTML = `
    <div class="extra-card" style="margin-bottom:0;">
        <details>
            <summary><span>üö® Minik N√∂bet G√ºnl√ºƒü√º</span> <span class="show-text">G√∂ster ‚ñº</span></summary>
            <div style="margin-top:12px; border-top:1px dashed var(--line); padding-top:8px;">`;

    if (nobetLogs.length === 0) {
        nobetHTML += `<div style="text-align:center; color:var(--muted); font-size:11px; padding:6px 0;">√áok ≈ü√ºk√ºr, hen√ºz kayƒ±t yok! üßø</div>`;
    } else {
        nobetLogs.forEach(n => {
            const nDate = n.dt.getDate() + ' ' + n.dt.toLocaleDateString('tr-TR', {month:'long'}) + ' ' + n.dt.getFullYear();
            nobetHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
                    <div>
                        <div style="font-weight:800; font-size:12px; color:#ef4444;">${nDate}</div>
                        <div style="font-size:10px; color:var(--muted); margin-top:2px;">Kayƒ±t: ${n.by}</div>
                    </div>
                    <div style="font-weight:900; font-size:14px; font-family:monospace; color:#fff;">${fmt(n.dt)}</div>
                </div>`;
        });
    }
    nobetHTML += `</div></details></div>`;

    document.getElementById('extra-cards').innerHTML = leaderHTML + nobetHTML;

    // Hafƒ±zadaki a√ßƒ±k men√ºleri geri y√ºkle
    document.querySelectorAll('details').forEach((d, i) => { if (detailsState[i]) d.open = true; });
}

veriCek();
setInterval(veriCek, 10000); 
setInterval(saniyeTiktak, 1000); 
document.addEventListener("visibilitychange", () => { if (document.visibilityState === 'visible') veriCek(); });
</script>
</body>
</html>

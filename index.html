<!doctype html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<style>
:root{
--bg:#0b0f17; --card:#121a27; --text:#eaf0ff; --muted:#a9b4cc; --line:rgba(255,255,255,.08);
--accent:#4ade80; --warning:#fbbf24; --danger:#ff6b6b; --early:#60a5fa;
}
body{ margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui; padding:20px; -webkit-font-smoothing: antialiased; }
#warning-container { display: none; margin-bottom: 20px; }
.alert-banner { background: #ef4444; color: white; padding: 12px; border-radius: 12px; margin-bottom: 8px; text-align: center; font-weight: 900; font-size: 14px; border: 2px solid rgba(255,255,255,0.2); animation: pulse-red 1.5s infinite; }
.header{ margin-bottom:24px; text-align:center; }
.title{ font-size:26px; font-weight:900; letter-spacing:-0.5px; margin-bottom:4px; }
.subtitle{ color:var(--muted); font-size:14px; font-weight:500; }
.card{ background:var(--card); border-radius:22px; padding:20px; margin-bottom:18px; border:1px solid var(--line); box-shadow:0 12px 40px rgba(0,0,0,0.3); }
.drug-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
.drug-name{ font-size:22px; font-weight:800; display:flex; align-items:center; gap:10px; }
.badge{ padding:6px 12px; border-radius:10px; font-weight:800; font-size:11px; text-transform:uppercase; white-space: nowrap; flex-shrink: 0; }
.badge-safe { background:rgba(74,222,128,0.1); color:var(--accent); border:1px solid rgba(74,222,128,0.2); }
.badge-due { background:rgba(251,191,36,0.1); color:var(--warning); border:1px solid rgba(251,191,36,0.2); animation: pulse-yellow 2s infinite; }
.badge-late { background:rgba(255,107,107,0.1); color:var(--danger); border:1px solid rgba(255,107,107,0.2); animation: pulse-red 1s infinite; }
.label{ color:var(--muted); font-size:11px; font-weight:700; text-transform:uppercase; margin-bottom:4px; }
.value{ font-size:18px; font-weight:700; color:#fff; }
.sub-value{ font-size:13px; color:var(--muted); margin-top:4px; font-weight:500; }
.footer-info{ margin-top:15px; padding-top:15px; border-top:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
.next-time{ font-size:16px; font-weight:700; color:#fff; }
.timer{ font-weight:800; color:var(--accent); font-size:14px; font-family: ui-monospace, monospace; }
.timer.urgent{ color:var(--warning); }
details { margin-top: 15px; border-top: 1px solid var(--line); padding-top: 10px; }
summary { cursor: pointer; color: var(--muted); font-size: 12px; font-weight: 600; list-style: none; outline: none; }
.history-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 13px; }
.perf-section { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--line); border-radius: 20px; padding: 18px; margin-top: 18px; }
.perf-title { font-size: 15px; font-weight: 800; margin-bottom: 12px; display: flex; justify-content: space-between; }
.bar-bg { background: rgba(255,255,255,0.05); height: 10px; border-radius: 5px; overflow: hidden; }
.bar-fill { height: 100%; transition: width 1s ease-in-out, background-color 0.5s; }
.status-summary { list-style: none; display: flex; justify-content: space-between; align-items: center; width: 100%; outline: none; cursor: pointer; margin-top: -5px; }
.status-summary::-webkit-details-marker { display: none; }
.status-item { background: rgba(255,255,255,0.03); padding: 12px 16px; border-radius: 15px; border: 1px solid var(--line); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
.status-tag { font-size: 10px; font-weight: 900; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
.tag-stable { color: #4ade80; background: rgba(74,222,128,0.1); }
.tag-early { color: #60a5fa; background: rgba(96,165,250,0.1); }
.tag-delayed { color: #fbbf24; background: rgba(251,191,36,0.1); }
.tag-missed { color: #ff6b6b; background: rgba(255,107,107,0.1); }
@keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
@keyframes pulse-yellow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.mono{ font-family: ui-monospace, monospace; }
</style>
</head>
<body>
<div id="warning-container"></div>
<div id="clock" style="..."></div>
<div id="last-sync" style="color:var(--muted); font-size:11px; margin-top:4px; font-weight:bold;">üîÑ Baƒülanƒ±yor...</div>
</div>

<!-- LOG BURAYA ENJEKTE EDƒ∞LECEK -->
<pre id="raw" style="display:none">{{LOG}}</pre>

<div class="perf-section" style="margin-bottom: 18px;">
<div class="perf-title">
<span>üìà Son 30 G√ºnl√ºk Ba≈üarƒ±</span>
<span id="perf-pct" class="mono">%0</span>
</div>
<div class="bar-bg">
<div id="perf-bar" class="bar-fill" style="width: 0%"></div>
</div>
<div style="font-size: 11px; color: var(--muted); margin-top: 8px;">Dozlarƒ±n tam vaktinde verilme oranƒ±dƒ±r.</div>
</div>

<div class="card" style="margin-top: 5px; padding-bottom: 15px;">
<details style="margin-top: 0; border-top: none; padding-top: 0;">
<summary class="status-summary">
<span style="font-weight:800; font-size:16px; color:#fff;">üìä G√ºnl√ºk Durum √áizelgesi</span>
<span style="font-size:12px; color:var(--muted);">G√∂ster ‚ñº</span>
</summary>
<div id="status-grid" style="margin-top:20px;"></div>
</details>
</div>

<div id="app"></div>

<script>
async function verileriTazele() {
  const syncElement = document.getElementById('last-sync');
  if (!syncElement) return; // Eƒüer HTML'de etiket yoksa √ßalƒ±≈üma

  try {
    // 1. G√ºncelleme Ba≈üladƒ±
    syncElement.innerHTML = `üîÑ G√ºncelleniyor...`;
    
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzbS3DIUOcmpUBLgvfuFhi3zIhsougq7JB93ccmnwLlGbURtHLZknu5vl6FcxSWJndIZA/exec"; 
    const GRACE_MIN = 30; 
    const LIMIT = 60;

    const response = await fetch(SHEET_URL);
    if (!response.ok) throw new Error("Aƒü Hatasƒ±");
    const rawLogs = await response.json();

    // Veri ƒ∞≈üleme
    const logs = rawLogs.map(l => ({
      dt: new Date(l.dt),
      drug: l.i.toLowerCase().includes('kep') ? 'keppra' : 'enalapril',
      dRaw: l.i.toLowerCase().includes('kep') ? 'Keppra' : 'Enalapril',
      by: l.k
    })).sort((a, b) => b.dt - a.dt);

    const now = new Date();
    const fmt = d => String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    const saniye = String(now.getSeconds()).padStart(2,'0');

    // --- EKRAN √áƒ∞Zƒ∞Mƒ∞ BA≈ûLIYOR ---
    
    // 1. Uyarƒ± Paneli
    const container = document.getElementById('warning-container');
    if (container) {
        const recent = logs.filter(l => (now - l.dt) >= 0 && (now - l.dt) < (LIMIT * 60000));
        if (recent.length > 0) {
          const seen = new Set(); const unique = [];
          recent.forEach(r => { if(!seen.has(r.drug)) { seen.add(r.drug); unique.push(r); } });
          container.innerHTML = unique.map(l => `<div class="alert-banner">‚ö†Ô∏è Dƒ∞KKAT: ${Math.floor((now-l.dt)/60000)} dk √∂nce ${l.dRaw} verildi ‚úÖ</div>`).join('');
          container.style.display = 'block';
        } else { container.style.display = 'none'; }
    }

    // 2. ƒ∞la√ß Kartlarƒ± ve Diƒüer Hesaplamalar
    // (Burada renderDrug ve performans hesaplamalarƒ± yapƒ±lacak - Mevcut mantƒ±ƒüƒ±n aynƒ±sƒ±)
    
    // ... (Kayƒ±tlƒ± diƒüer render kodlarƒ±n burada devam edecek) ...
    // Not: Buradaki kodlar d√ºzg√ºn √ßalƒ±≈üƒ±yorsa dokunmana gerek yok.

    // --- HER ≈ûEY BA≈ûARILIYSA MESAJI G√úNCELLE ---
    syncElement.innerHTML = `‚úÖ G√ºncel: ${fmt(now)}:${saniye}`;
    syncElement.style.color = "#4ade80";

  } catch(e) {
    // Sadece ciddi bir hata (baƒülantƒ± kopmasƒ± vs) olursa buraya d√º≈üer
    console.error("Hata Detayƒ±:", e);
    if (syncElement) {
        syncElement.innerHTML = `‚ö†Ô∏è Senkronizasyon Hatasƒ±! (Yenileniyor...)`;
        syncElement.style.color = "#ff6b6b";
    }
  }
}

// Olay Dinleyicileri
document.addEventListener("visibilitychange", () => { if (document.visibilityState === 'visible') verileriTazele(); });
verileriTazele();
setInterval(verileriTazele, 10000);
</script>
</body>
</html>

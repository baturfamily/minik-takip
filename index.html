<!doctype html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>Minik Saƒülƒ±k Paneli</title>
<style>
:root{
--bg:#0b0f17; --card:#121a27; --text:#eaf0ff; --muted:#a9b4cc; --line:rgba(255,255,255,.08);
--accent:#4ade80; --warning:#fbbf24; --danger:#ff6b6b; --early:#60a5fa;
}
body{ margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui; padding-bottom:40px; -webkit-font-smoothing: antialiased; }

/* ZIRHLI G√úVENLƒ∞K KALKANI */
.safety-shield {
    display: none;
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
    color: white; padding: 18px 15px; text-align: center;
    font-weight: 900; font-size: 15px;
    position: sticky; top: 0; z-index: 9999;
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
    animation: pulse-red 1.5s infinite;
    letter-spacing: 0.5px;
}

.content-wrapper { padding: 20px; }
.header{ margin-bottom:24px; text-align:center; }
.title{ font-size:26px; font-weight:900; letter-spacing:-0.5px; margin-bottom:4px; }
.subtitle{ color:var(--muted); font-size:14px; font-weight:500; margin-bottom: 6px; }

.card{ background:var(--card); border-radius:22px; padding:20px; margin-bottom:18px; border:1px solid var(--line); box-shadow:0 12px 40px rgba(0,0,0,0.3); }
.drug-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
.drug-name{ font-size:22px; font-weight:800; display:flex; align-items:center; gap:10px; }
.badge{ padding:6px 12px; border-radius:10px; font-weight:800; font-size:11px; text-transform:uppercase; white-space: nowrap; flex-shrink: 0; }
.badge-safe { background:rgba(74,222,128,0.1); color:var(--accent); border:1px solid rgba(74,222,128,0.2); }
.badge-due { background:rgba(251,191,36,0.1); color:var(--warning); border:1px solid rgba(251,191,36,0.2); animation: pulse-yellow 2s infinite; }
.badge-late { background:rgba(255,107,107,0.1); color:var(--danger); border:1px solid rgba(255,107,107,0.2); animation: pulse-red 1s infinite; }
.label{ color:var(--muted); font-size:11px; font-weight:700; text-transform:uppercase; margin-bottom:4px; }
.value{ font-size:18px; font-weight:700; color:#fff; }
.sub-value{ font-size:13px; color:var(--muted); margin-top:4px; font-weight:500; }
.footer-info{ margin-top:15px; padding-top:15px; border-top:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
.next-time{ font-size:16px; font-weight:700; color:#fff; }
.timer{ font-weight:800; color:var(--accent); font-size:14px; font-family: ui-monospace, monospace; }
.timer.urgent{ color:var(--warning); }
details { margin-top: 15px; border-top: 1px solid var(--line); padding-top: 10px; }
summary { cursor: pointer; color: var(--muted); font-size: 12px; font-weight: 600; list-style: none; outline: none; }
.history-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 13px; }
.perf-section { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--line); border-radius: 20px; padding: 18px; margin-bottom: 18px; }
.perf-title { font-size: 15px; font-weight: 800; margin-bottom: 12px; display: flex; justify-content: space-between; }
.bar-bg { background: rgba(255,255,255,0.05); height: 10px; border-radius: 5px; overflow: hidden; }
.bar-fill { height: 100%; transition: width 1s ease-in-out, background-color 0.5s; }
.status-summary { list-style: none; display: flex; justify-content: space-between; align-items: center; width: 100%; outline: none; cursor: pointer; margin-top: -5px; }
.status-summary::-webkit-details-marker { display: none; }
.status-item { background: rgba(255,255,255,0.03); padding: 12px 16px; border-radius: 15px; border: 1px solid var(--line); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
.status-tag { font-size: 10px; font-weight: 900; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
.tag-stable { color: #4ade80; background: rgba(74,222,128,0.1); }
.tag-early { color: #60a5fa; background: rgba(96,165,250,0.1); }
.tag-delayed { color: #fbbf24; background: rgba(251,191,36,0.1); }
.tag-missed { color: #ff6b6b; background: rgba(255,107,107,0.1); }
@keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
@keyframes pulse-yellow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.mono{ font-family: ui-monospace, monospace; }
</style>
</head>
<body>

<div id="safety-shield" class="safety-shield"></div>

<div class="content-wrapper">
    <div class="header">
        <div class="title">üêæ Minik Paneli</div>
        <div id="clock" class="subtitle">Saat Y√ºkleniyor...</div>
        <div id="last-sync" style="color:var(--muted); font-size:12px; font-weight:800; background:rgba(0,0,0,0.2); display:inline-block; padding:6px 14px; border-radius:15px;">
            üîÑ Sisteme Baƒülanƒ±yor...
        </div>
    </div>

    <div class="perf-section">
        <div class="perf-title">
            <span>üìà 30 G√ºnl√ºk Ba≈üarƒ±</span>
            <span id="perf-pct" class="mono">%0</span>
        </div>
        <div class="bar-bg">
            <div id="perf-bar" class="bar-fill" style="width: 0%"></div>
        </div>
    </div>

    <div class="card" style="margin-top: 5px; padding-bottom: 15px;">
        <details style="margin-top: 0; border-top: none; padding-top: 0;">
            <summary class="status-summary">
                <span style="font-weight:800; font-size:16px; color:#fff;">üìä G√ºnl√ºk √áizelge</span>
                <span style="font-size:12px; color:var(--muted);">A√ß / Kapat ‚ñº</span>
            </summary>
            <div id="status-grid" style="margin-top:20px;"></div>
        </details>
    </div>

    <div id="app"></div>
</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbzbS3DIUOcmpUBLgvfuFhi3zIhsougq7JB93ccmnwLlGbURtHLZknu5vl6FcxSWJndIZA/exec"; 
let sonBasariZamani = 0;
let hamVeri = [];
let fetchDevamEdiyor = false;

// 1. VERƒ∞ √áEKME MOTORU (10 Saniyede Bir √áalƒ±≈üƒ±r)
async function veriCek() {
    if (fetchDevamEdiyor) return;
    fetchDevamEdiyor = true;

    try {
        const response = await fetch(SHEET_URL);
        if (!response.ok) throw new Error("Aƒü Hatasƒ±");
        hamVeri = await response.json();
        sonBasariZamani = Date.now();
        ekraniCiz(); // Sadece veri ba≈üarƒ±yla geldiƒüinde ekranƒ± g√ºnceller
    } catch(e) {
        console.error("Baƒülantƒ± Hatasƒ±:", e);
    } finally {
        fetchDevamEdiyor = false;
    }
}

// 2. CANLI TRAFƒ∞K I≈ûIƒûI (Her saniye tƒ±klar)
function saniyeTiktak() {
    const syncElement = document.getElementById('last-sync');
    const clockElement = document.getElementById('clock');
    if (!syncElement) return;

    const simdi = Date.now();
    const farkSaniye = sonBasariZamani > 0 ? Math.floor((simdi - sonBasariZamani) / 1000) : 999;

    // Saat formatƒ±
    const dNow = new Date();
    const fmtSaat = String(dNow.getHours()).padStart(2,'0') + ':' + String(dNow.getMinutes()).padStart(2,'0');
    if(clockElement) clockElement.textContent = dNow.getDate() + " " + dNow.toLocaleDateString('tr-TR', {month:'long'}) + " ‚Ä¢ " + fmtSaat;

    // Trafik I≈üƒ±ƒüƒ± Mantƒ±ƒüƒ±
    if (sonBasariZamani === 0) {
        syncElement.innerHTML = `üîÑ ƒ∞lk veriler alƒ±nƒ±yor...`;
        syncElement.style.color = "var(--warning)";
    } else if (farkSaniye < 20) {
        const d = new Date(sonBasariZamani);
        const sn = String(d.getSeconds()).padStart(2,'0');
        syncElement.innerHTML = `üü¢ Canlƒ± Veri (${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${sn})`;
        syncElement.style.color = "#4ade80";
    } else if (farkSaniye < 60) {
        syncElement.innerHTML = `üü° Gecikme Var: ${farkSaniye} sn √∂nce`;
        syncElement.style.color = "#fbbf24";
    } else {
        syncElement.innerHTML = `üî¥ Dƒ∞KKAT: BAƒûLANTI YOK! (${farkSaniye} sn)`;
        syncElement.style.color = "#ef4444";
    }
}

// 3. EKRAN √áƒ∞Zƒ∞M MOTORU
function ekraniCiz() {
    if (hamVeri.length === 0) return;

    // A√ßƒ±k olan men√ºleri (details) hafƒ±zaya al
    const detailsState = {};
    document.querySelectorAll('details').forEach((d, i) => detailsState[i] = d.open);

    const logs = hamVeri.map(l => ({
        dt: new Date(l.dt),
        drug: l.i.toLowerCase().includes('kep') ? 'keppra' : 'enalapril',
        dRaw: l.i.toLowerCase().includes('kep') ? 'Keppra' : 'Enalapril',
        by: l.k
    })).sort((a, b) => b.dt - a.dt);

    const now = new Date();
    const GRACE_MIN = 30;
    const fmt = d => String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    const isToday = (d) => d.toDateString() === now.toDateString();

    // --- ZIRHLI KORUMA KALKANI ---
    const shield = document.getElementById('safety-shield');
    // Son 60 dakika i√ßinde ila√ß verilmi≈ü mi kontrol et
    const son60dk = logs.filter(l => (now - l.dt) >= 0 && (now - l.dt) < (60 * 60000));
    if (son60dk.length > 0) {
        const r = son60dk[0]; // En son verilen ilacƒ± al
        const dkOnce = Math.floor((now - r.dt) / 60000);
        const metin = dkOnce === 0 ? "az √∂nce" : `${dkOnce} dk √∂nce`;
        shield.innerHTML = `üö® Dƒ∞KKAT: ${r.dRaw}, ${r.by} tarafƒ±ndan ${metin} verildi!`;
        shield.style.display = 'block';
    } else {
        shield.style.display = 'none';
    }

    // --- ƒ∞LA√á KARTLARI ---
    const keppraTimes = [{h:7,m:0},{h:15,m:0},{h:23,m:0}];
    const enalaprilTimes = [{h:10,m:30},{h:22,m:30}];

    function getNextSmart(name) {
        const pArr = name.toLowerCase() === 'keppra' ? keppraTimes : enalaprilTimes;
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        let cands = [];
        [-1, 0, 1].forEach(off => {
            pArr.forEach(t => { cands.push(new Date(today.getTime() + (off * 86400000) + (t.h*3600 + t.m*60)*1000)); });
        });
        cands.sort((a,b) => a-b);
        return cands.find(c => {
            const wasDone = logs.find(l => l.drug === name.toLowerCase() && Math.abs(l.dt - c) < (4 * 3600000));
            return !wasDone && c > now.getTime() - (GRACE_MIN*60000);
        }) || cands.find(c => c > now);
    }

    function renderDrug(name, icon) {
        const dLogs = logs.filter(l => l.drug === name.toLowerCase()); 
        const last = dLogs[0];
        const next = getNextSmart(name);
        const diffMin = Math.round((next - now) / 60000);
        
        let status = { text: "BEKLEMEDE", class: "badge-safe" };
        if (last && (now - last.dt) >= 0 && (now - last.dt) < (GRACE_MIN * 60000)) {
            status = { text: "YENƒ∞ VERƒ∞LDƒ∞", class: "badge-safe" };
        } else if (diffMin <= 0 && diffMin >= -GRACE_MIN) {
            status = { text: "VAKTƒ∞ GELDƒ∞", class: "badge-due" };
        } else if (diffMin < -GRACE_MIN) {
            status = { text: "GECƒ∞KTƒ∞", class: "badge-late" };
        }

        const h = Math.floor(Math.abs(diffMin) / 60); const m = Math.abs(diffMin) % 60;
        const diffStr = diffMin < 0 ? "Vakti ge√ßti!" : (h > 0 ? `${h}sa ${m}dk` : `${m}dk`);
        const lastGivenStr = last ? `${isToday(last.dt) ? "Bug√ºn" : last.dt.getDate()+'/'+(last.dt.getMonth()+1)} ${fmt(last.dt)}` : 'Yok';

        return `
            <div class="card">
                <div class="drug-header"><div class="drug-name">${icon} ${name}</div><div class="badge ${status.class}">${status.text}</div></div>
                <div class="label">Son Verili≈ü</div><div class="value">${lastGivenStr}</div><div class="sub-value">${last ? last.by + ' verdi' : ''}</div>
                <div class="footer-info">
                    <div><div class="label">Sƒ±radaki</div><div class="next-time">${fmt(next)}</div></div>
                    <div class="timer ${diffMin < 60 ? 'urgent' : ''}">${diffStr}</div>
                </div>
                <details><summary>üìú Son 5 Doz Ge√ßmi≈üi ‚ñº</summary><ul style="list-style:none; padding:0; margin-top:10px">
                    ${dLogs.slice(0,5).map(h => `<li class="history-item"><span class="mono">${h.dt.getDate()}/${h.dt.getMonth()+1} ${fmt(h.dt)}</span><span style="font-weight:700">${h.by}</span></li>`).join('')}
                </ul></details>
            </div>`;
    }

    document.getElementById('app').innerHTML = renderDrug('Keppra', 'üíâ') + renderDrug('Enalapril', 'üíä');

    // --- G√úNL√úK √áƒ∞ZELGE VE PERFORMANS ---
    const allPlans = [
        {n:'Keppra',h:7,m:0},{n:'Keppra',h:15,m:0},{n:'Keppra',h:23,m:0},
        {n:'Enalapril',h:10,m:30},{n:'Enalapril',h:22,m:30}
    ];

    let startCalc = new Date(now.getTime() - (30 * 86400000)); startCalc.setHours(0,0,0,0);
    let totalP = 0, stableC = 0, grid = "";
    
    allPlans.sort((a,b)=>(a.h*60+a.m)-(b.h*60+b.m)).forEach(p => {
        const pt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), p.h, p.m);
        const log = logs.find(l => l.drug === p.n.toLowerCase() && Math.abs(l.dt - pt) < (4 * 3600000));
        let tag = log ? "tag-stable" : (now > new Date(pt.getTime() + 30*60000) ? "tag-missed" : "tag-waiting");
        grid += `<div class="status-item"><span>${p.n} (${fmt(pt)})</span><span class="status-tag ${tag}">${log ? 'TAMAM' : 'BEKLƒ∞YOR'}</span></div>`;
    });

    for(let d=new Date(startCalc); d<=now; d.setDate(d.getDate()+1)){
        allPlans.forEach(p => {
            const pt = new Date(d.getFullYear(), d.getMonth(), d.getDate(), p.h, p.m);
            if(pt >= startCalc && pt <= now){
                totalP++;
                if(logs.find(l => l.drug === p.n.toLowerCase() && Math.abs(l.dt - pt.getTime()) <= (GRACE_MIN*60000))) stableC++;
            }
        });
    }

    const pct = totalP > 0 ? Math.round((stableC/totalP)*100) : 0;
    const clr = pct >= 80 ? "#4ade80" : (pct >= 50 ? "#fbbf24" : "#ff6b6b");
    
    const perfPctEl = document.getElementById('perf-pct');
    const perfBarEl = document.getElementById('perf-bar');
    if(perfPctEl) { perfPctEl.textContent = '%'+pct; perfPctEl.style.color = clr; }
    if(perfBarEl) { perfBarEl.style.width = pct+'%'; perfBarEl.style.backgroundColor = clr; }
    
    const gridEl = document.getElementById('status-grid');
    if(gridEl) gridEl.innerHTML = grid;

    // Hafƒ±zadaki a√ßƒ±k men√ºleri geri y√ºkle
    document.querySelectorAll('details').forEach((d, i) => {
        if (detailsState[i]) d.open = true;
    });
}

// 4. BA≈ûLATICILAR VE ZAMANLAYICILAR
veriCek(); // A√ßƒ±lƒ±r a√ßƒ±lmaz veriyi getir
setInterval(veriCek, 10000); // 10 saniyede bir arka planda Google'a sor
setInterval(saniyeTiktak, 1000); // Her saniye saatleri ve ƒ±≈üƒ±ƒüƒ± g√ºncelle
document.addEventListener("visibilitychange", () => { 
    if (document.visibilityState === 'visible') veriCek(); 
});
</script>
</body>
</html>
